<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

    <title>连图</title>
    <script type="text/javascript">
    function appendItem() {
        var item = "<div class='col-sm-12 item'> \
                        <a class='file-input-wrapper btn btn-success btn-block'> \
                            <span>浏览</span> \
                            <input class='imageLoader' type='file' name='pic' accept='image/*' data-filename-placement='inside'> \
                        </a> \
                        <textarea name='des' class='btn-block afterbrowse' ></textarea> \
                        <img class='img-responsive' id='thumbnail' > \
                        <input class='imageHidden' name='pic' type='hidden' > \
                        <button type='button' class='remove btn btn-block btn-default afterbrowse' aria-label='Remove Image'>删除 </button> \
                    </div>";

        $$("#items").append(item);
        
        $$(document).ready(function(){$$('input[type=file]').bootstrapFileInput();});

        $$( document ).ready(function() {
            $$( ".remove" ).click(function( event ) {
                $$(this).closest('.item').fadeOut(300, function(){$$(this).remove(); });
            });
        });

        $$( document ).ready(function() {
            $$( ".imageLoader").change(function() {
                var img = ($$(this).closest("a").siblings("#thumbnail")[0])
                img.src = window.URL.createObjectURL(this.files[0]);

                var imageCanvas = document.createElement("canvas");
                var ctx = imageCanvas.getContext("2d");

                var imageHidden =  ($$(this).closest("a").siblings(".imageHidden")[0]);

                $$(this).closest("a").siblings(".afterbrowse").show();

                img.onload=function(){
                    var MAX_WIDTH = 800;
                    var MAX_HEIGHT = 600;
                    var width = img.width;
                    var height = img.height;
                     
                    if (width > height) {
                      if (width > MAX_WIDTH) {
                        height *= MAX_WIDTH / width;
                        width = MAX_WIDTH;
                      }
                    } else {
                      if (height > MAX_HEIGHT) {
                        width *= MAX_HEIGHT / height;
                        height = MAX_HEIGHT;
                      }
                    }
                    
                    imageCanvas.width = width;
                    imageCanvas.height = height;

                    ctx.drawImage(img, 0, 0, width, height);
                    imageHidden.value=imageCanvas.toDataURL("image/jpeg");
                    appendItem();
                }
            });
        });        
    }
    </script>

    <script src="static/js/jquery.js"></script>
    <link rel="stylesheet" type="text/css" href="/static/dist/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="/static/css/gallery-page-index.css">

    <script src="static/js/bootstrap.file-input.js"></script>
    <script>
        $$(document).ready(function(){
            $$('input[type=file]').bootstrapFileInput();
        });

        $$( document ).ready(function() {
            $$( ".imageLoader").change(function() {
                var img = ($$(this).closest("a").siblings("#thumbnail")[0])
                img.src = window.URL.createObjectURL(this.files[0]);

                var imageCanvas = document.createElement("canvas");
                var ctx = imageCanvas.getContext("2d");

                var imageHidden =  ($$(this).closest("a").siblings(".imageHidden")[0]);

                $$(this).closest("a").siblings(".afterbrowse").show();

                img.onload=function(){
                    var MAX_WIDTH = 800;
                    var MAX_HEIGHT = 600;
                    var width = img.width;
                    var height = img.height;
                     
                    if (width > height) {
                      if (width > MAX_WIDTH) {
                        height *= MAX_WIDTH / width;
                        width = MAX_WIDTH;
                      }
                    } else {
                      if (height > MAX_HEIGHT) {
                        width *= MAX_HEIGHT / height;
                        height = MAX_HEIGHT;
                      }
                    }
                    
                    imageCanvas.width = width;
                    imageCanvas.height = height;

                    ctx.drawImage(img, 0, 0, width, height);
                    imageHidden.value=imageCanvas.toDataURL("image/jpeg");
                    appendItem();
                }
            });
        });

        $$( document ).ready(function() {
            $$( ".remove" ).click(function( event ) {
                $$(this).closest('.item').fadeOut(300, function(){$$(this).remove(); });
            });
        });

        $$( document ).ready(function() {
            $$( ".generate" ).click(function( event ) {
                $$(".imageLoader").prop("disabled", true);
                $$("#theform").submit();
            });
        });
    </script>
</head>

<body>
    <div class="container">

        <form id="theform" action="" enctype="multipart/form-data" method="post" role="form" class="form-horizontal">
            <div class="form-group">
                <div class="col-sm-12">
                    <input class="form-control" type="text" name="pageTitle" value="标题">
                </div>
            </div>

            <div id="items" class="form-group">
                <div class="col-sm-12 item">
                    <a class="file-input-wrapper btn btn-success btn-block">
                        <span>浏览</span>
                        <input class="imageLoader" type="file" name="pic" accept="image/*" data-filename-placement="inside" >
                    </a>
                    
                    <textarea name="des" class="btn-block afterbrowse" > </textarea>

                    <img class="img-responsive" id="thumbnail" ></img>
                    <input class="imageHidden" name="pic" type="hidden" >

                    <button type="button" class="remove btn btn-block btn-default afterbrowse" aria-label="Remove Image">
                        删除
                    </button>
                </div>
            </div>


             <button type="submit" class="btn btn-primary btn-block generate">
                  生成网页
             </button>
        </form>
    </div>

    <div class="footer">
        <div class="container">
            <p class="text-muted">© Arthur <span class="secret">For Garfield</span></p>
        </div>
    </div>
</body>
</html>